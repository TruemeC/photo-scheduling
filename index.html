<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', Tahoma, sans-serif; margin: 0; padding: 0; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-scheduled { background: #dbeafe; color: #1d4ed8; }
        .status-filmed { background: #d1fae5; color: #059669; }
        .status-published { background: #c4b5fd; color: #7c3aed; }
        .status-cancelled { background: #fee2e2; color: #dc2626; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root">
        <div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f9fafb;">
            <div style="text-align:center;">
                <div style="width:48px;height:48px;border:4px solid #6366f1;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div>
                <p style="margin-top:16px;font-size:18px;color:#6366f1;font-weight:500;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
        
        window.firebaseReady = true;
        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy
        };
        
        // ØªØ´ØºÙŠÙ„ React Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Firebase
        window.dispatchEvent(new Event('firebase-loaded'));
    </script>

    <script type="text/babel">
        const waitForFirebase = () => {
            return new Promise((resolve) => {
                if (window.firebaseReady) {
                    resolve();
                } else {
                    window.addEventListener('firebase-loaded', resolve);
                }
            });
        };

        const startApp = async () => {
            await waitForFirebase();
            
            const { useState, useEffect, useCallback, useMemo } = React;
            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy } = window.firebaseModules;

            // ==================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ====================
            const appId = 'call-center-tracker';
            
            const firebaseConfig = { 
                apiKey: "AIzaSyA_dbbHDgZXHD9MeO-Sp0LOlXzjmdmfO60",
                authDomain: "call-center-tracker.firebaseapp.com",
                projectId: "call-center-tracker",
                storageBucket: "call-center-tracker.appspot.com",
                messagingSenderId: "27240160136",
                appId: "1:27240160136:web:8c1298ca8e9e1a2881383d"
            };

            const ZAPIER_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/YOUR_HOOK_ID/';

            const ROLES = {
                MARKETING_MANAGER: 'Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠÙ‚',
                OWNER: 'Ø§Ù„Ù…Ø§Ù„Ùƒ',
                ACCOUNTANT: 'Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©',
                DOCTOR: 'Ø·Ø¨ÙŠØ¨'
            };

            const DEFAULT_DOCTORS = [
                { id: 'dr-shazia', name: 'Ø¯. Ø´Ø§Ø²ÙŠØ§ Ø¹Ù„ÙŠ', email: '', phone: '' },
                { id: 'dr-mohammad', name: 'Ø¯. Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¨ÙŠ', email: '', phone: '' },
                { id: 'dr-asmaa', name: 'Ø¯. Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠ', email: '', phone: '' },
                { id: 'dr-israa', name: 'Ø¯. Ø§Ø³Ø±Ø§Ø¡ Ø­Ø¬Ø§Ø¬ÙŠ', email: '', phone: '' },
                { id: 'dept-devices', name: 'Ù‚Ø³Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©', email: '', phone: '' }
            ];

            // ==================== Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ====================
            const Icons = {
                Camera: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                Calendar: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
                Check: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>,
                Share: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>,
                Plus: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>,
                Edit: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>,
                Trash: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                Users: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
                Report: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            };

            // ==================== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© ====================
            const StatCard = ({ title, value, icon: Icon, color }) => (
                <div className={`bg-white p-6 rounded-2xl shadow-lg border-2 ${color} flex items-center justify-between`}>
                    <div>
                        <p className="text-gray-500 text-sm font-medium">{title}</p>
                        <p className="text-4xl font-bold text-gray-800 mt-1">{value}</p>
                    </div>
                    <div className={`p-4 rounded-xl ${color.replace('border', 'bg').replace('-200', '-100')}`}>
                        <Icon />
                    </div>
                </div>
            );

            // ==================== Ø§Ù„Ø´Ø§Ø±Øª ====================
            const SessionsChart = ({ sessions, doctors }) => {
                const chartRef = React.useRef(null);
                const chartInstance = React.useRef(null);

                React.useEffect(() => {
                    if (chartRef.current && doctors.length > 0) {
                        const ctx = chartRef.current.getContext('2d');
                        
                        const doctorStats = doctors.map(doc => {
                            const docSessions = sessions.filter(s => s.doctorId === doc.id);
                            return { name: doc.name, total: docSessions.length };
                        }).filter(d => d.total > 0);

                        const total = doctorStats.reduce((sum, d) => sum + d.total, 0);
                        const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4'];

                        if (chartInstance.current) chartInstance.current.destroy();

                        const datalabelsPlugin = {
                            id: 'datalabels',
                            afterDatasetsDraw: function(chart) {
                                const chartCtx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value === 0 || total === 0) return;
                                        const percentage = ((value / total) * 100).toFixed(0);
                                        const position = element.tooltipPosition();
                                        chartCtx.fillStyle = '#ffffff';
                                        chartCtx.font = 'bold 14px Inter';
                                        chartCtx.textAlign = 'center';
                                        chartCtx.textBaseline = 'middle';
                                        chartCtx.fillText(percentage + '%', position.x, position.y);
                                    });
                                });
                            }
                        };

                        chartInstance.current = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: doctorStats.map(d => d.name),
                                datasets: [{ data: doctorStats.map(d => d.total), backgroundColor: colors.slice(0, doctorStats.length), borderWidth: 3, borderColor: '#ffffff' }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    title: { display: true, text: 'ğŸ“¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¨', font: { size: 14, weight: 'bold' }, color: '#4f46e5' }
                                }
                            },
                            plugins: [datalabelsPlugin]
                        });

                        const legendContainer = document.getElementById('chart-legend');
                        if (legendContainer) {
                            legendContainer.innerHTML = doctorStats.map((item, i) => {
                                const percentage = total > 0 ? ((item.total / total) * 100).toFixed(1) : '0.0';
                                return '<div style="display:inline-flex;align-items:center;margin:5px 10px;font-size:12px;font-weight:bold;"><span style="width:12px;height:12px;background:' + colors[i] + ';border-radius:50%;margin-left:6px;"></span>' + item.name + ': ' + item.total + ' (' + percentage + '%)</div>';
                            }).join('');
                        }
                    }
                }, [sessions, doctors]);

                return (
                    <div className="bg-white p-6 rounded-2xl shadow-xl border border-indigo-50 flex flex-col items-center h-full min-h-[350px]">
                        <h3 className="text-lg font-black text-indigo-600 mb-2">ğŸ† ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</h3>
                        <div className="relative w-full flex-grow"><canvas ref={chartRef}></canvas></div>
                        <div id="chart-legend" className="flex flex-wrap justify-center mt-3" style={{direction: 'rtl'}}></div>
                    </div>
                );
            };

            // ==================== Modal ====================
            const Modal = ({ isOpen, onClose, title, children }) => {
                if (!isOpen) return null;
                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-center mb-4 border-b pb-3">
                                <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                            </div>
                            {children}
                        </div>
                    </div>
                );
            };

            // ==================== Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====================
            const App = () => {
                const [db, setDb] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);
                const [loading, setLoading] = useState(true);
                const [statusMessage, setStatusMessage] = useState('');
                const [sessions, setSessions] = useState([]);
                const [doctors, setDoctors] = useState(DEFAULT_DOCTORS);
                const [currentRole, setCurrentRole] = useState(ROLES.MARKETING_MANAGER);
                const [currentDoctorId, setCurrentDoctorId] = useState(null);
                const [showSessionModal, setShowSessionModal] = useState(false);
                const [showDoctorModal, setShowDoctorModal] = useState(false);
                const [showReportModal, setShowReportModal] = useState(false);
                const [editingSession, setEditingSession] = useState(null);
                const [editingDoctor, setEditingDoctor] = useState(null);
                const [sessionForm, setSessionForm] = useState({ doctorId: '', sessionDate: '', sessionTitle: '', serviceType: '', filmingStatus: 'Ù…Ø¬Ø¯ÙˆÙ„', publishStatus: 'ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±', notes: '' });
                const [doctorForm, setDoctorForm] = useState({ name: '', email: '', phone: '' });

                const todayDate = useMemo(() => new Date().toLocaleString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' }), []);
                const isMarketingManager = currentRole === ROLES.MARKETING_MANAGER;

                useEffect(() => {
                    try {
                        const app = initializeApp(firebaseConfig);
                        const firestore = getFirestore(app);
                        const authInstance = getAuth(app);
                        setDb(firestore);

                        onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setIsAuthReady(true);
                            } else {
                                await signInAnonymously(authInstance);
                            }
                            setLoading(false);
                        });
                    } catch (e) {
                        console.error("Firebase Error:", e);
                        setLoading(false);
                    }
                }, []);

                useEffect(() => {
                    if (!db || !isAuthReady) return;
                    const sessionsPath = 'artifacts/' + appId + '/public/data/photoSessions';
                    const q = query(collection(db, sessionsPath));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const newSessions = [];
                        snapshot.forEach((docSnap) => { newSessions.push({ id: docSnap.id, ...docSnap.data() }); });
                        setSessions(newSessions);
                    });
                    return () => unsubscribe();
                }, [db, isAuthReady]);

                useEffect(() => {
                    if (!db || !isAuthReady) return;
                    const doctorsPath = 'artifacts/' + appId + '/public/data/doctors';
                    const unsubscribe = onSnapshot(collection(db, doctorsPath), (snapshot) => {
                        if (snapshot.empty) {
                            DEFAULT_DOCTORS.forEach(d => { setDoc(doc(db, doctorsPath, d.id), d); });
                            setDoctors(DEFAULT_DOCTORS);
                        } else {
                            const newDoctors = [];
                            snapshot.forEach((docSnap) => { newDoctors.push({ id: docSnap.id, ...docSnap.data() }); });
                            setDoctors(newDoctors);
                        }
                    });
                    return () => unsubscribe();
                }, [db, isAuthReady]);

                const filteredSessions = useMemo(() => {
                    if (currentRole === ROLES.DOCTOR && currentDoctorId) {
                        return sessions.filter(s => s.doctorId === currentDoctorId);
                    }
                    return sessions;
                }, [sessions, currentRole, currentDoctorId]);

                const stats = useMemo(() => {
                    const now = new Date();
                    return {
                        total: filteredSessions.length,
                        upcoming: filteredSessions.filter(s => new Date(s.sessionDate) >= now && s.filmingStatus === 'Ù…Ø¬Ø¯ÙˆÙ„').length,
                        filmed: filteredSessions.filter(s => s.filmingStatus === 'ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±').length,
                        published: filteredSessions.filter(s => s.publishStatus === 'ØªÙ… Ø§Ù„Ù†Ø´Ø±').length
                    };
                }, [filteredSessions]);

                const handleSaveSession = async () => {
                    if (!db || !sessionForm.doctorId || !sessionForm.sessionDate || !sessionForm.sessionTitle) {
                        setStatusMessage('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                        return;
                    }
                    try {
                        const sessionId = editingSession ? editingSession.id : 'session-' + Date.now();
                        const sessionData = { ...sessionForm, lastUpdate: serverTimestamp(), createdAt: editingSession ? editingSession.createdAt : serverTimestamp() };
                        await setDoc(doc(db, 'artifacts/' + appId + '/public/data/photoSessions', sessionId), sessionData);
                        setStatusMessage(editingSession ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­');
                        setShowSessionModal(false);
                        resetSessionForm();
                    } catch (error) {
                        setStatusMessage('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    }
                };

                const handleDeleteSession = async (sessionId) => {
                    if (!window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ')) return;
                    try {
                        await deleteDoc(doc(db, 'artifacts/' + appId + '/public/data/photoSessions', sessionId));
                        setStatusMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©');
                    } catch (error) {
                        setStatusMessage('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    }
                };

                const handleUpdateStatus = async (session, field, value) => {
                    try {
                        await setDoc(doc(db, 'artifacts/' + appId + '/public/data/photoSessions', session.id), { ...session, [field]: value, lastUpdate: serverTimestamp() });
                        setStatusMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
                    } catch (error) {
                        setStatusMessage('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    }
                };

                const handleSaveDoctor = async () => {
                    if (!db || !doctorForm.name) { setStatusMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨'); return; }
                    try {
                        const doctorId = editingDoctor ? editingDoctor.id : 'dr-' + Date.now();
                        await setDoc(doc(db, 'artifacts/' + appId + '/public/data/doctors', doctorId), { id: doctorId, ...doctorForm });
                        setStatusMessage(editingDoctor ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨ÙŠØ¨');
                        setShowDoctorModal(false);
                        resetDoctorForm();
                    } catch (error) {
                        setStatusMessage('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    }
                };

                const handleDeleteDoctor = async (doctorId) => {
                    if (!window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ØŸ')) return;
                    try {
                        await deleteDoc(doc(db, 'artifacts/' + appId + '/public/data/doctors', doctorId));
                        setStatusMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø¨ÙŠØ¨');
                    } catch (error) {
                        setStatusMessage('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    }
                };

                const resetSessionForm = () => { setSessionForm({ doctorId: '', sessionDate: '', sessionTitle: '', serviceType: '', filmingStatus: 'Ù…Ø¬Ø¯ÙˆÙ„', publishStatus: 'ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±', notes: '' }); setEditingSession(null); };
                const resetDoctorForm = () => { setDoctorForm({ name: '', email: '', phone: '' }); setEditingDoctor(null); };

                const openEditSession = (session) => {
                    setSessionForm({ doctorId: session.doctorId, sessionDate: session.sessionDate, sessionTitle: session.sessionTitle, serviceType: session.serviceType || '', filmingStatus: session.filmingStatus, publishStatus: session.publishStatus, notes: session.notes || '' });
                    setEditingSession(session);
                    setShowSessionModal(true);
                };

                const openEditDoctor = (doctor) => {
                    setDoctorForm({ name: doctor.name, email: doctor.email || '', phone: doctor.phone || '' });
                    setEditingDoctor(doctor);
                    setShowDoctorModal(true);
                };

                const generateReport = () => {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    const monthSessions = sessions.filter(s => { const d = new Date(s.sessionDate); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; });
                    return doctors.map(doc => {
                        const docSessions = monthSessions.filter(s => s.doctorId === doc.id);
                        return { doctor: doc.name, scheduled: docSessions.length, filmed: docSessions.filter(s => s.filmingStatus === 'ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±' || s.publishStatus === 'ØªÙ… Ø§Ù„Ù†Ø´Ø±').length, published: docSessions.filter(s => s.publishStatus === 'ØªÙ… Ø§Ù„Ù†Ø´Ø±').length, cancelled: docSessions.filter(s => s.filmingStatus === 'Ù…Ù„ØºÙŠ').length };
                    }).filter(r => r.scheduled > 0);
                };

                const getStatusClass = (status) => {
                    switch(status) {
                        case 'Ù…Ø¬Ø¯ÙˆÙ„': return 'status-scheduled';
                        case 'ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±': return 'status-filmed';
                        case 'ØªÙ… Ø§Ù„Ù†Ø´Ø±': return 'status-published';
                        case 'Ù…Ù„ØºÙŠ': return 'status-cancelled';
                        default: return 'status-scheduled';
                    }
                };

                if (loading) {
                    return (
                        <div className="flex justify-center items-center h-screen bg-gray-50">
                            <div className="text-center">
                                <div className="animate-spin w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                                <p className="mt-4 text-lg font-medium text-indigo-600">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="min-h-screen bg-gray-50 p-4 sm:p-8" dir="rtl">
                        <div className="max-w-7xl mx-auto">
                            
                            <header className="flex flex-col sm:flex-row justify-between items-start mb-6 pb-4 border-b">
                                <div>
                                    <h1 className="text-3xl font-extrabold text-indigo-700 flex items-center">
                                        <span className="ml-3">ğŸ“¸</span> Ù†Ø¸Ø§Ù… Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ
                                    </h1>
                                    <p className="mt-1 text-gray-600 flex items-center"><Icons.Calendar /><span className="mr-2">{todayDate}</span></p>
                                </div>
                                
                                <div className="mt-4 sm:mt-0 flex flex-col items-end gap-2">
                                    <label className="text-sm text-gray-600">Ø¹Ø±Ø¶ Ø¨ØµÙØ©:</label>
                                    <select value={currentRole} onChange={(e) => { setCurrentRole(e.target.value); if (e.target.value !== ROLES.DOCTOR) setCurrentDoctorId(null); }} className="px-4 py-2 border rounded-lg bg-white shadow-sm">
                                        <option value={ROLES.MARKETING_MANAGER}>Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠÙ‚ (ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„)</option>
                                        <option value={ROLES.OWNER}>Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù…ØªØ§Ø¨Ø¹Ø© Ø´Ø§Ù…Ù„Ø©)</option>
                                        <option value={ROLES.ACCOUNTANT}>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© (Ù„Ù„Ø¹Ù„Ù…)</option>
                                        <option value={ROLES.DOCTOR}>Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ (Ø¬Ø¯ÙˆÙ„ÙŠ ÙÙ‚Ø·)</option>
                                    </select>
                                    {currentRole === ROLES.DOCTOR && (
                                        <select value={currentDoctorId || ''} onChange={(e) => setCurrentDoctorId(e.target.value)} className="px-4 py-2 border rounded-lg bg-white shadow-sm">
                                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ --</option>
                                            {doctors.map(doc => (<option key={doc.id} value={doc.id}>{doc.name}</option>))}
                                        </select>
                                    )}
                                </div>
                            </header>

                            {isMarketingManager && (
                                <div className="flex flex-wrap gap-3 mb-6">
                                    <button onClick={() => { resetSessionForm(); setShowSessionModal(true); }} className="flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition shadow-lg"><Icons.Plus /> Ø¬Ø¯ÙˆÙ„Ø© ØªØµÙˆÙŠØ± Ø¬Ø¯ÙŠØ¯</button>
                                    <button onClick={() => { resetDoctorForm(); setShowDoctorModal(true); }} className="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition shadow-lg"><Icons.Users /> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</button>
                                    <button onClick={() => setShowReportModal(true)} className="flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 transition shadow-lg"><Icons.Report /> Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
                                </div>
                            )}

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                <StatCard title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª" value={stats.total} icon={Icons.Camera} color="border-blue-200" />
                                <StatCard title="Ø¬Ù„Ø³Ø§Øª Ù‚Ø§Ø¯Ù…Ø©" value={stats.upcoming} icon={Icons.Calendar} color="border-yellow-200" />
                                <StatCard title="ØªÙ… ØªØµÙˆÙŠØ±Ù‡Ø§" value={stats.filmed} icon={Icons.Check} color="border-green-200" />
                                <StatCard title="ØªÙ… Ø§Ù„Ù†Ø´Ø±" value={stats.published} icon={Icons.Share} color="border-purple-200" />
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-1"><SessionsChart sessions={filteredSessions} doctors={doctors} /></div>
                                <div className="lg:col-span-2">
                                    <div className="bg-white rounded-2xl shadow-xl border border-indigo-50 overflow-hidden">
                                        <div className="p-6 border-b"><h2 className="text-xl font-bold text-gray-800 flex items-center"><Icons.Calendar /><span className="mr-2">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</span></h2></div>
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full divide-y divide-gray-200">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ / Ø§Ù„Ù‚Ø³Ù…</th>
                                                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØµÙˆÙŠØ±</th>
                                                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ù„Ø³Ø©</th>
                                                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØ±</th>
                                                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø±</th>
                                                        {isMarketingManager && <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>}
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200">
                                                    {filteredSessions.map(session => {
                                                        const doctor = doctors.find(d => d.id === session.doctorId);
                                                        return (
                                                            <tr key={session.id} className="hover:bg-gray-50">
                                                                <td className="px-4 py-4">
                                                                    <div className="flex items-center">
                                                                        <span className="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm ml-3">{doctor?.name?.charAt(0) || '?'}</span>
                                                                        <span className="font-medium text-gray-900">{doctor?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-4 text-center text-sm text-gray-600">{session.sessionDate}</td>
                                                                <td className="px-4 py-4 text-center text-sm text-gray-800 font-medium">{session.sessionTitle}</td>
                                                                <td className="px-4 py-4 text-center">
                                                                    {isMarketingManager ? (
                                                                        <select value={session.filmingStatus} onChange={(e) => handleUpdateStatus(session, 'filmingStatus', e.target.value)} className={'status-badge ' + getStatusClass(session.filmingStatus) + ' border-0 cursor-pointer'}>
                                                                            <option value="Ù…Ø¬Ø¯ÙˆÙ„">Ù…Ø¬Ø¯ÙˆÙ„</option>
                                                                            <option value="ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±">ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±</option>
                                                                            <option value="Ù…Ù„ØºÙŠ">Ù…Ù„ØºÙŠ</option>
                                                                        </select>
                                                                    ) : (<span className={'status-badge ' + getStatusClass(session.filmingStatus)}>{session.filmingStatus}</span>)}
                                                                </td>
                                                                <td className="px-4 py-4 text-center">
                                                                    {isMarketingManager ? (
                                                                        <select value={session.publishStatus} onChange={(e) => handleUpdateStatus(session, 'publishStatus', e.target.value)} className={'status-badge ' + (session.publishStatus === 'ØªÙ… Ø§Ù„Ù†Ø´Ø±' ? 'status-published' : 'bg-gray-100 text-gray-600') + ' border-0 cursor-pointer'}>
                                                                            <option value="ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±">ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±</option>
                                                                            <option value="ØªÙ… Ø§Ù„Ù†Ø´Ø±">ØªÙ… Ø§Ù„Ù†Ø´Ø±</option>
                                                                        </select>
                                                                    ) : (<span className={'status-badge ' + (session.publishStatus === 'ØªÙ… Ø§Ù„Ù†Ø´Ø±' ? 'status-published' : 'bg-gray-100 text-gray-600')}>{session.publishStatus}</span>)}
                                                                </td>
                                                                {isMarketingManager && (
                                                                    <td className="px-4 py-4 text-center">
                                                                        <div className="flex items-center justify-center gap-2">
                                                                            <button onClick={() => openEditSession(session)} className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg"><Icons.Edit /></button>
                                                                            <button onClick={() => handleDeleteSession(session.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg"><Icons.Trash /></button>
                                                                        </div>
                                                                    </td>
                                                                )}
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                            {filteredSessions.length === 0 && <p className="text-center text-gray-500 py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø©</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {statusMessage && (
                                <div className="fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-96 bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                                    {statusMessage}
                                    <button onClick={() => setStatusMessage('')} className="mr-4 font-bold">Ã—</button>
                                </div>
                            )}

                            <Modal isOpen={showSessionModal} onClose={() => { setShowSessionModal(false); resetSessionForm(); }} title={editingSession ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©' : 'Ø¬Ø¯ÙˆÙ„Ø© ØªØµÙˆÙŠØ± Ø¬Ø¯ÙŠØ¯'}>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø·Ø¨ÙŠØ¨ / Ø§Ù„Ù‚Ø³Ù… *</label><select value={sessionForm.doctorId} onChange={(e) => setSessionForm({...sessionForm, doctorId: e.target.value})} className="w-full px-4 py-2 border rounded-lg"><option value="">-- Ø§Ø®ØªØ± --</option>{doctors.map(doc => (<option key={doc.id} value={doc.id}>{doc.name}</option>))}</select></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØµÙˆÙŠØ± *</label><input type="date" value={sessionForm.sessionDate} onChange={(e) => setSessionForm({...sessionForm, sessionDate: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ù„Ø³Ø© / Ø§Ù„Ø®Ø¯Ù…Ø© *</label><input type="text" value={sessionForm.sessionTitle} onChange={(e) => setSessionForm({...sessionForm, sessionTitle: e.target.value})} placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙˆØªÙˆÙƒØ³ ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆØ¬Ù‡" className="w-full px-4 py-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label><input type="text" value={sessionForm.serviceType} onChange={(e) => setSessionForm({...sessionForm, serviceType: e.target.value})} placeholder="Ù…Ø«Ø§Ù„: ØªØ¬Ù…ÙŠÙ„ØŒ Ù„ÙŠØ²Ø±ØŒ ÙÙŠÙ„Ø±" className="w-full px-4 py-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea value={sessionForm.notes} onChange={(e) => setSessionForm({...sessionForm, notes: e.target.value})} placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." className="w-full px-4 py-2 border rounded-lg" rows="3" /></div>
                                    <button onClick={handleSaveSession} className="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">{editingSession ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù„Ø³Ø©'}</button>
                                </div>
                            </Modal>

                            <Modal isOpen={showDoctorModal} onClose={() => { setShowDoctorModal(false); resetDoctorForm(); }} title={editingDoctor ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨' : 'Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨ Ø¬Ø¯ÙŠØ¯'}>
                                <div className="space-y-4">
                                    {!editingDoctor && (
                                        <div className="mb-6">
                                            <h4 className="font-semibold text-gray-700 mb-3">Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†:</h4>
                                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                                {doctors.map(doc => (
                                                    <div key={doc.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                        <span className="font-medium">{doc.name}</span>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => openEditDoctor(doc)} className="p-1 text-indigo-600 hover:bg-indigo-100 rounded"><Icons.Edit /></button>
                                                            <button onClick={() => handleDeleteDoctor(doc.id)} className="p-1 text-red-600 hover:bg-red-100 rounded"><Icons.Trash /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            <hr className="my-4" />
                                            <h4 className="font-semibold text-gray-700 mb-3">Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨ Ø¬Ø¯ÙŠØ¯:</h4>
                                        </div>
                                    )}
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ / Ø§Ù„Ù‚Ø³Ù… *</label><input type="text" value={doctorForm.name} onChange={(e) => setDoctorForm({...doctorForm, name: e.target.value})} placeholder="Ø¯. Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" className="w-full px-4 py-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" value={doctorForm.email} onChange={(e) => setDoctorForm({...doctorForm, email: e.target.value})} placeholder="doctor@clinic.com" className="w-full px-4 py-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label><input type="tel" value={doctorForm.phone} onChange={(e) => setDoctorForm({...doctorForm, phone: e.target.value})} placeholder="966512345678" className="w-full px-4 py-2 border rounded-lg" /></div>
                                    <button onClick={handleSaveDoctor} className="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">{editingDoctor ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨ÙŠØ¨'}</button>
                                </div>
                            </Modal>

                            <Modal isOpen={showReportModal} onClose={() => setShowReportModal(false)} title="ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ">
                                <div>
                                    <p className="text-gray-600 mb-4">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø± {new Date().toLocaleString('ar-SA', { month: 'long', year: 'numeric' })}</p>
                                    <table className="min-w-full divide-y divide-gray-200 mb-4">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-3 py-2 text-right text-xs font-medium text-gray-500">Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
                                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500">Ù…Ø¬Ø¯ÙˆÙ„</th>
                                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500">ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±</th>
                                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500">ØªÙ… Ø§Ù„Ù†Ø´Ø±</th>
                                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500">Ù…Ù„ØºÙŠ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {generateReport().map((row, i) => (
                                                <tr key={i}>
                                                    <td className="px-3 py-2 text-sm font-medium">{row.doctor}</td>
                                                    <td className="px-3 py-2 text-center text-sm">{row.scheduled}</td>
                                                    <td className="px-3 py-2 text-center text-sm text-green-600 font-semibold">{row.filmed}</td>
                                                    <td className="px-3 py-2 text-center text-sm text-purple-600 font-semibold">{row.published}</td>
                                                    <td className="px-3 py-2 text-center text-sm text-red-600">{row.cancelled}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {generateReport().length === 0 && <p className="text-center text-gray-500 py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>}
                                    <button onClick={() => setShowReportModal(false)} className="w-full py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Ø¥ØºÙ„Ø§Ù‚</button>
                                </div>
                            </Modal>

                        </div>
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };

        startApp();
    </script>
</body>
</html>
